/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.1
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
(function(e){var c={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:false,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:true,theme:null,zindex:999,resultsFormatter:function(g){return"<li>"+g[this.propertyToSearch]+"</li>"},tokenFormatter:function(g){return"<li><p>"+g[this.propertyToSearch]+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,highlightDuplicates:true,tokenValue:"id",onResult:null,onAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:false,allowCustomEntry:false};var f={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",disabled:"token-input-disabled"};var d={BEFORE:0,AFTER:1,END:2};var a={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};var b={init:function(g,h){var i=e.extend({},c,h||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,g,i))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(g){this.data("tokenInputObject").add(g);return this},remove:function(g){this.data("tokenInputObject").remove(g);return this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(g){this.data("tokenInputObject").toggleDisabled(g);return this}};e.fn.tokenInput=function(g){if(b[g]){return b[g].apply(this,Array.prototype.slice.call(arguments,1))}else{return b.init.apply(this,arguments)}};e.TokenList=function(i,t,T){if(e.type(t)==="string"||e.type(t)==="function"){T.url=t;var m=y();if(T.crossDomain===undefined&&typeof m==="string"){if(m.indexOf("://")===-1){T.crossDomain=false}else{T.crossDomain=(location.href.split(/\/+/g)[1]!==m.split(/\/+/g)[1])}}}else{if(typeof(t)==="object"){T.local_data=t}}if(T.classes){T.classes=e.extend({},f,T.classes)}else{if(T.theme){T.classes={};e.each(f,function(Z,aa){T.classes[Z]=aa+"-"+T.theme})}else{T.classes=f}}var H=[];var w=0;var s=new e.TokenList.Cache();var R;var O;var A=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",T.idPrefix+i.id).focus(function(){if(T.disabled){return false}else{if(T.tokenLimit===null||T.tokenLimit!==w){l()}}}).blur(function(){I();e(this).val("")}).bind("keyup keydown blur update",g).keydown(function(aa){var ac;var Z;switch(aa.keyCode){case a.LEFT:case a.RIGHT:case a.UP:case a.DOWN:if(!e(this).val()){ac=n.prev();Z=n.next();if((ac.length&&ac.get(0)===E)||(Z.length&&Z.get(0)===E)){if(aa.keyCode===a.LEFT||aa.keyCode===a.UP){L(e(E),d.BEFORE)}else{L(e(E),d.AFTER)}}else{if((aa.keyCode===a.LEFT||aa.keyCode===a.UP)&&ac.length){U(e(ac.get(0)))}else{if((aa.keyCode===a.RIGHT||aa.keyCode===a.DOWN)&&Z.length){U(e(Z.get(0)))}}}}else{var ab=null;if(aa.keyCode===a.DOWN||aa.keyCode===a.RIGHT){ab=e(Q).next()}else{ab=e(Q).prev()}if(ab.length){X(ab)}}return false;break;case a.BACKSPACE:ac=n.prev();if(!e(this).val().length){if(E){k(e(E));G.change()}else{if(ac.length){U(e(ac.get(0)))}}return false}else{if(e(this).val().length===1){I()}else{setTimeout(function(){D()},5)}}break;case a.TAB:case a.ENTER:case a.NUMPAD_ENTER:if(Q){return q()}else{if(T.allowCustomEntry){return F()}}break;case a.COMMA:if(T.allowCustomEntry){return F()}else{if(Q){return q()}}break;case a.ESCAPE:I();return true;default:if(String.fromCharCode(aa.which)){setTimeout(function(){D()},5)}break}});function q(){N(e(Q).data("tokeninput"));G.change();return false}function F(){var Z={name:e("#"+T.idPrefix+i.id).val()};N(Z);G.change();return false}var G=e(i).hide().val("").focus(function(){Y(A)}).blur(function(){A.blur()});var E=null;var J=0;var Q=null;var p=e("<ul />").addClass(T.classes.tokenList).click(function(aa){var Z=e(aa.target).closest("li");if(Z&&Z.get(0)&&e.data(Z.get(0),"tokeninput")){W(Z)}else{if(E){L(e(E),d.END)}Y(A)}}).mouseover(function(aa){var Z=e(aa.target).closest("li");if(Z&&E!==this){Z.addClass(T.classes.highlightedToken)}}).mouseout(function(aa){var Z=e(aa.target).closest("li");if(Z&&E!==this){Z.removeClass(T.classes.highlightedToken)}}).insertBefore(G);var n=e("<li />").addClass(T.classes.inputToken).appendTo(p).append(A);var V=e("<div>").addClass(T.classes.dropdown).appendTo("body").hide();var M=e("<tester/>").insertAfter(A).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:A.css("fontSize"),fontFamily:A.css("fontFamily"),fontWeight:A.css("fontWeight"),letterSpacing:A.css("letterSpacing"),whiteSpace:"nowrap"});G.val("");var z=T.prePopulate||G.data("pre");if(T.processPrePopulate&&e.isFunction(T.onResult)){z=T.onResult.call(G,z)}if(z&&z.length){e.each(z,function(Z,aa){j(aa);K()})}if(T.disabled){C(true)}if(e.isFunction(T.onReady)){T.onReady.call()}this.clear=function(){p.children("li").each(function(){if(e(this).children("input").length===0){k(e(this))}})};this.add=function(Z){N(Z)};this.remove=function(Z){p.children("li").each(function(){if(e(this).children("input").length===0){var ac=e(this).data("tokeninput");var aa=true;for(var ab in Z){if(Z[ab]!==ac[ab]){aa=false;break}}if(aa){k(e(this))}}})};this.getTokens=function(){return H};this.toggleDisabled=function(Z){C(Z)};function C(Z){if(typeof Z==="boolean"){T.disabled=Z}else{T.disabled=!T.disabled}A.prop("disabled",T.disabled);p.toggleClass(T.classes.disabled,T.disabled);if(E){L(e(E),d.END)}G.prop("disabled",T.disabled)}function K(){if(T.tokenLimit!==null&&w>=T.tokenLimit){A.hide();I();return}}function g(){if(O===(O=A.val())){return}var Z=O.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");M.html(Z);A.width(M.width()+30)}function S(Z){return((Z>=48&&Z<=90)||(Z>=96&&Z<=111)||(Z>=186&&Z<=192)||(Z>=219&&Z<=222))}function j(Z){var ab=T.tokenFormatter(Z);ab=e(ab).addClass(T.classes.token).insertBefore(n);e("<span>"+T.deleteText+"</span>").addClass(T.classes.tokenDelete).appendTo(ab).click(function(){if(!T.disabled){k(e(this).parent());G.change();return false}});var aa=Z;e.data(ab.get(0),"tokeninput",Z);H=H.slice(0,J).concat([aa]).concat(H.slice(J));J++;x(H,G);w+=1;if(T.tokenLimit!==null&&w>=T.tokenLimit){A.hide();I()}return ab}function N(Z){var ab=T.onAdd;if(w>0&&T.preventDuplicates){var aa=null;p.children().each(function(){var ad=e(this);var ac=e.data(ad.get(0),"tokeninput");if(ac&&ac[T.tokenValue]===Z[T.tokenValue]){aa=ad;return false}});if(aa){if(T.highlightDuplicates){U(aa);n.insertAfter(aa);Y(A)}return}}if(T.tokenLimit==null||w<T.tokenLimit){j(Z);K()}A.val("");I();if(e.isFunction(ab)){ab.call(G,Z)}}function U(Z){if(!T.disabled){Z.addClass(T.classes.selectedToken);E=Z.get(0);A.val("");I()}}function L(aa,Z){aa.removeClass(T.classes.selectedToken);E=null;if(Z===d.BEFORE){n.insertBefore(aa);J--}else{if(Z===d.AFTER){n.insertAfter(aa);J++}else{n.appendTo(p);J=w}}Y(A)}function W(aa){var Z=E;if(E){L(e(E),d.END)}if(Z===aa.get(0)){L(aa,d.END)}else{U(aa)}}function k(aa){var ab=e.data(aa.get(0),"tokeninput");var ac=T.onDelete;var Z=aa.prevAll().length;if(Z>J){Z--}aa.remove();E=null;Y(A);H=H.slice(0,Z).concat(H.slice(Z+1));if(Z<J){J--}x(H,G);w-=1;if(T.tokenLimit!==null){A.show().val("");Y(A)}if(e.isFunction(ac)){ac.call(G,ab)}}function x(ab,Z){var aa=e.map(ab,function(ac){if(typeof T.tokenValue=="function"){return T.tokenValue.call(this,ac)}return ac[T.tokenValue]});Z.val(aa.join(T.tokenDelimiter))}function I(){V.hide().empty();Q=null}function r(){V.css({position:"absolute",top:e(p).offset().top+e(p).outerHeight(),left:e(p).offset().left,width:e(p).outerWidth(),"z-index":T.zindex}).show()}function o(){if(T.searchingText){V.html("<p>"+T.searchingText+"</p>");r()}}function l(){if(T.hintText){V.html("<p>"+T.hintText+"</p>");r()}}function v(aa,Z){return aa.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+Z+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function B(aa,ab,Z){return aa.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+ab+")(?![^<>]*>)(?![^&;]+;)","g"),v(ab,Z))}function P(ab,Z){if(Z&&Z.length){V.empty();var aa=e("<ul>").appendTo(V).mouseover(function(ac){X(e(ac.target).closest("li"))}).mousedown(function(ac){N(e(ac.target).closest("li").data("tokeninput"));G.change();return false}).hide();e.each(Z,function(ac,ad){var ae=T.resultsFormatter(ad);ae=B(ae,ad[T.propertyToSearch],ab);ae=e(ae).appendTo(aa);if(ac%2){ae.addClass(T.classes.dropdownItem)}else{ae.addClass(T.classes.dropdownItem2)}if(ac===0){X(ae)}e.data(ae.get(0),"tokeninput",ad)});r();if(T.animateDropdown){aa.slideDown("fast")}else{aa.show()}}else{if(T.noResultsText){V.html("<p>"+T.noResultsText+"</p>");Q=null;r()}}}function X(Z){if(Z){if(Q){h(e(Q))}Z.addClass(T.classes.selectedDropdownItem);Q=Z.get(0)}}function h(Z){Z.removeClass(T.classes.selectedDropdownItem);Q=null}function D(){var Z=A.val();if(Z&&Z.length){if(E){L(e(E),d.AFTER)}if(Z.length>=T.minChars){o();clearTimeout(R);R=setTimeout(function(){u(Z)},T.searchDelay)}else{I()}}}function u(af){var ah=this;var aa=af+y();var ag=s.get(aa);if(ag){P(af,ag)}else{if(T.url){var Z=y();var ae={};ae.data={};if(Z.indexOf("?")>-1){var ac=Z.split("?");ae.url=ac[0];var ab=ac[1].split("&");e.each(ab,function(ai,ak){var aj=ak.split("=");ae.data[aj[0]]=aj[1]})}else{ae.url=Z}ae.data[T.queryParam]=af;ae.type=T.method;ae.dataType=T.contentType;if(T.crossDomain){ae.dataType="jsonp"}ae.success=function(ai){if(e.isFunction(T.onResult)){ai=T.onResult.call(G,ai)}s.add(aa,T.jsonContainer?ai[T.jsonContainer]:ai);if(A.val()===af){P(af,T.jsonContainer?ai[T.jsonContainer]:ai)}};if(typeof ah.currentSearchRequest!=="undefined"){ah.currentSearchRequest.abort()}ah.currentSearchRequest=e.ajax(ae)}else{if(T.local_data){var ad=e.grep(T.local_data,function(ai){return ai[T.propertyToSearch].toLowerCase().indexOf(af.toLowerCase())>-1});if(e.isFunction(T.onResult)){ad=T.onResult.call(G,ad)}s.add(aa,ad);P(af,ad)}}}}function y(){var Z=T.url;if(typeof T.url=="function"){Z=T.url.call(T)}return Z}function Y(Z){setTimeout(function(){Z.focus()},50)}};e.TokenList.Cache=function(h){var j=e.extend({max_size:500},h);var k={};var i=0;var g=function(){k={};i=0};this.add=function(m,l){if(i>j.max_size){g()}if(!k[m]){i+=1}k[m]=l};this.get=function(l){return k[l]}}}(jQuery));